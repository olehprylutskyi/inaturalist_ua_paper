---
title: "State-of-the-art of iNaturalist as a source of data on Ukrainian Funga"
author: "Oleh Prylutskyi, Nadiia Kapets"
date: "`r Sys.Date()`"
output: html_document
# output: word_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

V.N. Karazin Kharkiv National University, Svobody sq. 4, 61022 Kharkiv, Ukraine; [prylutskyi\@karazin.ua](mailto:prylutskyi@karazin.ua)

<https://orcid.org/0000-0001-5730-517X>

**Abstract.**
This study evaluates the utility of iNaturalist, a citizen science platform, for mycological research in Ukraine. With over 69,000 fungal observations documented since its adoption, iNaturalist presents a significant potential for supplementing professional mycological surveys. This work is novel in critically analysing the spatial distribution, taxonomic coverage, and identification accuracy of iNaturalist fungal data, with a particular focus on social processes underlying citizen scientists' activity in Ukraine over the last five years. We explored observers' activity and compared iNaturalist records with curated checklists and additional data sources. Despite inherent biases, our analysis shows that iNaturalist effectively documents conspicuous macroscopic fungi, often surpassing traditional sources in record numbers. However, limitations such as identification uncertainty and lack of voucher specimens persist, necessitating greater professional engagement. Enhanced collaboration between amateur and professional mycologists could unlock iNaturalist’s full potential, making it a robust tool for biodiversity monitoring and research in Ukraine.

**Keywords:** iNaturalist, citizen science, fungi, Ukraine, spatial distribution, rare species monitoring.

## Data sources
We downloaded an archive of all observations, available on iNaturalist as of 1 June 2024, and meet the following criteria: (i) lie within the official state boundary of Ukraine, (ii) belong to the Fungi Kingdom, and (iii) verifiable (accompanied by photos). Total number of downloaded records was 69,211. Data dump, along with the R code for reproducing the analysis, were archived on GitHub repository (https://github.com/olehprylutskyi/inaturalist_ua_paper).

The state boundary of Ukraine, as well as its administrative division, was acquired using the rgeoboundaries package v. 1.2.9 (Dicko 2023). Population density data for Ukraine were acquired from the Gridded Population of the World, Version 4 (GPWv4): Population Density, Revision 11 (https://sedac.ciesin.columbia.edu/data/set/gpw-v4-population-density-rev11). Ukrainian war events data were downloaded from ACLED's Ukraine Conflict Monitor (https://acleddata.com/ukraine-conflict-monitor/).

```{r, Environment preparation, message=FALSE}
# Environment preparation
rm(list = ls()) # Reset R`s brain
# Load libraries
library(tidyverse)
library(sf)
library(knitr)
library(gridExtra)
library(iNEXT)
library(rgbif)
library(terra)
library(iNEXT)
library(ggspatial)

# Download Ukraine regions as an `sf` polygon
# Uncomment following lines and run it only for the first time
# library(remotes)
# remotes::install_github("dickoa/rgeoboundaries")
# library(rgeoboundaries)
# ukraine_poly <- rgeoboundaries::gb_adm1("UKR")
# save(ukraine_poly, file = "Ukraine_poly_adm1.Rdata")

load(file = "./data/Ukraine_poly_adm1.Rdata")   # regions (oblast)

# Set custom theme for ggplot2 plots
mytheme <- theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank())

# Load data
# Specify previously saved iNaturalist data, as *.csv file.
# All fields must be checked before downloading.
inat_data <- "./data/observations_20240601.csv" # downloaded 2024-06-01

# Load data and convert it to `sf`
fungi <- read.csv(inat_data) %>% 
  # select required columns
  select(id,
         observed_on,
         user_id,
         user_name,
         quality_grade,
         url,
         num_identification_agreements,
         num_identification_disagreements,
         latitude,
         longitude,
         coordinates_obscured,
         place_admin1_name,
         place_admin2_name,
         scientific_name,
         taxon_id,
         taxon_phylum_name,
         taxon_subphylum_name,
         taxon_class_name,
         taxon_order_name,
         taxon_family_name,
         taxon_genus_name,
         taxon_species_name,
         taxon_subspecies_name,
         taxon_variety_name,
         taxon_form_name) %>% 
  mutate_at("id", as.character) %>% 
  mutate_at("observed_on", as.Date) %>% 
  filter(observed_on <= "2024-06-01") %>% 
  mutate_at(c(
    "user_name",
    "quality_grade",
    "coordinates_obscured",
    "place_admin1_name",
    "place_admin2_name",
    "scientific_name",
    "taxon_phylum_name",
    "taxon_subphylum_name",
    "taxon_class_name",
    "taxon_order_name",
    "taxon_family_name",
    "taxon_genus_name",
    "taxon_species_name",
    "taxon_subspecies_name",
    "taxon_variety_name",
    "taxon_form_name"
  ), as.factor) %>% 
  mutate(place_admin1_name = recode(place_admin1_name,
                                    "Crimea" = "Autonomous Republic of Crimea", # "old one" = "new one"
                                    "Cherkasy" = "Cherkasy Oblast",
                                    "Chernihiv" = "Chernihiv Oblast",
                                    "Chernivtsi" = "Chernivtsi Oblast",
                                    "Dnipropetrovs'k" = "Dnipropetrovsk Oblast",
                                    "Donets'k" = "Donetsk Oblast",
                                    "Kharkiv" = "Kharkiv Oblast",
                                    "Kherson" = "Kherson Oblast",
                                    "Khmel'nyts'kyy" = "Khmelnytskyi Oblast",
                                    "Kirovohrad" = "Kirovohrad Oblast",
                                    "Kiev" = "Kyiv Oblast",
                                    "Kiev City" = "Kyiv",
                                    "Luhans'k" = "Luhansk Oblast",
                                    "L'viv" = "Lviv Oblast",
                                    "Ivano-Frankivs'k" =  "Ivano-Frankivsk Oblast",
                                    "Mykolayiv" = "Mykolaiv Oblast",
                                    "Odessa" = "Odessa Oblast",
                                    "Poltava" = "Poltava Oblast",
                                    "Rivne" = "Rivne Oblast",
                                    "Sevastopol'" = "Sevastopol",
                                    "Sumy" = "Sumy Oblast",
                                    "Ternopil'" = "Ternopil Oblast",
                                    "Vinnytsya" = "Vinnytsia Oblast",
                                    "Volyn" = "Volyn Oblast",
                                    "Transcarpathia" = "Zakarpattia Oblast",
                                    "Zaporizhzhya" = "Zaporizhia Oblast",
                                    "Zhytomyr" = "Zhytomyr Oblast"
  )
         ) %>%
  # convert to `simple features` spatial object
  st_as_sf(dim = "XY", remove = FALSE, na.fail = F, 
                      coords = c("longitude", "latitude"), crs = "+proj=longlat +datum=WGS84 +no_defs") %>% 
  # clip by country polygon
  st_filter(ukraine_poly) %>% 
  # drop records without coordinates
  filter(!st_is_empty(.))
```

## Analysis and visualisation
To model species accumulation over growing of the number of observations (used as a proxy for sampling effort), we applied rarefaction with Hill numbers, using “abundance” datatype (Chao et al. 2014), implemented in the `iNEXT` R package (Hsieh, Ma, and Chao 2022).

To address the question of how accurate iNaturalist reflects real-world fungal species composition, we compare iNaturalist data with the data obtained from curated checklists made by professional mycologists and encompassing critically revised data from publications and scientific collections. Since Ukraine does not have an up-to-date checklist for all Fungi, we selected two case groups for which such checklists have been recently published: Order Lecanorales, one of the largest order among lichen-forming Ascomycota (Kondratyuk et al. 2021), and gilled representatives of Order Agaricales, mushroom-forming Basidiomycota (Prylutskyi et al. 2023). To ensure comparability, we unified taxonomy in both checklists and iNaturalist species lists using GBIF Species API (https://www.gbif.org/developer/species) via the `rgbif` R package. (Chamberlain et al. 2024).

To explore whether iNaturalist observations correspond with the species records from other sources, we selected two conspicuous case species, *Hericium coralloides* and *Clathrus archeri*. Records for these species were obtained from scientific papers (Heluta and Zykova 2018; Shevchenko et al. 2021; Heluta et al. 2022), and GBIF (GBIF.org 2024a, b, with iNaturalist research grade observation dataset excluded). For record accompanied by only textual location description, we georeferenced them semi-automatic using the Geocode by Awesome Table extension for Google Spreadsheets (https://awesome-table.com/), and then manually checked all data points with Google Maps (https://www.google.com/maps) and OpenStreetMap (https://www.openstreetmap.org/) map services.

Data transformations, analysis, and visualisations were performed with R statistical environment (R Core Team 2023). For regular data manipulation we used `tidyverse` metapackage (Wickham et al. 2019) along with basic R’s functionality. For spatial data manipulations (constructing the spatial grid, calculating observation points within each grid cell, making maps), we used `sf` package v. 1.0-14 (Pebesma 2018). All visualisations were made using `ggplot2` package v. 3.4.4 (Wickham et al. 2016).

```{r, Package citations}
citation("tidyverse")
citation("sf")
citation("ggplot2")
citation("rgeoboundaries")
citation("rgbif")
citation("iNEXT")
citation("terra")
```

# Results
## Species diversity and taxonomic coverage
As of 1 June 2024, Ukrainian segment of iNaturalist reported 2,090 fungal species, represented by 69,211 observations, with both numbers steadily increasing (Figure 1a).

```{r, Basic statistics}
paste0(length(unique(fungi$taxon_species_name)), " species")
paste0(nrow(fungi), " observations")
paste0(nrow(fungi[fungi$quality_grade == "research",]),
       " RG observations, (",
       round(nrow(fungi[fungi$quality_grade == "research",]) / nrow(fungi) * 100, digits = 2),
       " % of total)")
```


```{r, Rarefaction}
# Rarefaction curve
# Drop rows lacking species-level identification
fungi_species_only <- fungi %>%
  filter(taxon_species_name != "")

# Load iNEXT library and pre-process the data
library(iNEXT)
m1 <- as.matrix(table(fungi_species_only$taxon_species_name))
m2 <- list(m1)

# Construct iNEXT object for abundance data
out <- iNEXT(m2, q = 0, datatype = "abundance", endpoint = 65000)

# Plot the rarefaction curve
p_rarefaction <- ggiNEXT(out, type = 1)
p_rarefaction +
  labs(title = "(a) Rarefaction of species accumulation",
       x = "Number of observations",
       y = "Number of species") +
  mytheme +
  theme(legend.position="none") -> p_rarefaction

p_rarefaction
```


```{r, Identification agreements}
# Identification agreements
fungi %>% 
  mutate(num_identification_disagreements = as.factor(num_identification_disagreements)) %>% 
  ggplot(aes(x = num_identification_agreements,
             fill = num_identification_disagreements,
             colour = num_identification_disagreements)) +
  geom_bar(alpha = 0.8) +
  scale_x_continuous(breaks = c(0, 1, 2, 3, 4, 5, 6, 7)) +
  # scale_y_log10() +
  labs(
    x = "Number of identification agreements",
    y = "Number of observations",
    fill = "Number of\nidentification\ndisagreements",
    title = "(b) Identification activity"
  ) +
  guides(colour = FALSE) +
  mytheme +
  theme(
    # legend.title = element_text(size = 10),
    legend.position = c(.6, .7)
    ) -> id_agreements_p

id_agreements_p
```

```{r, Gilled Agaricales, warning=FALSE}
# iNaturalist
# Match taxonomic names against the GBIF Backbone Taxonomy
fungi %>%
  filter(taxon_order_name == "Agaricales") %>%
  select(taxon_species_name) %>%
  rename(name = taxon_species_name) %>%
  filter(name != "") %>%
  st_drop_geometry() %>%
  distinct() %>%
  mutate(kingdom = "Fungi") %>%
  mutate_if(is.factor, as.character) %>%
  st_drop_geometry() %>%
  # Matching names against GBIF Backbone Taxonomy and tidying data
  name_backbone_checklist() %>%
  filter(!is.na(species)) %>%
  select(species,
         order,
         family,
         genus) %>%
  filter(order == "Agaricales") %>% 
  filter(!family %in% c("Clavariaceae",
                        "Cyphellaceae",
                        "Fistulinaceae",
                        "Lycoperdaceae",
                        "Niaceae",
                        "Nidulariaceae",
                        "Phelloriniaceae",
                        "Pterulaceae",
                        "Radulomycetaceae",
                        "Schizophyllaceae",
                        "Stephanosporaceae",
                        "Typhulaceae")) %>%
  mutate_if(is.character, as.factor) %>%
  group_by(family) %>%
  summarise(count(.)) %>%
  distinct() %>%
  mutate(n = -n) %>%
  mutate(source = "iNaturalist") -> inat_data_taxon


# Unique species from the checklist
read.table("./data/agaricales.tsv", header = TRUE, sep = "\t") %>%
  select(scientificName, kingdom) %>%
  rename(name = scientificName) %>%
  mutate_if(is.factor, as.character) %>%
  # Matching names against GBIF Backbone Taxonomy and tidying data
  name_backbone_checklist() %>%
  filter(!is.na(species)) %>%
  select(species,
         order,
         family,
         genus) %>%
  filter(order == "Agaricales") %>% 
  mutate_if(is.character, as.factor) %>%
  group_by(family) %>%
  summarise(count(.)) %>%
  distinct() %>%
  mutate(source = "Prylutskyi et al. 2023") -> checklist_data_taxon

agaricales <- checklist_data_taxon %>%
  bind_rows(inat_data_taxon) %>%
  mutate(family = as.factor(family))

# Merge data and make a comparison barplot
agaricales %>% 
  ggplot(aes(x = family, y = n, fill = source)) +
  geom_bar(stat = "identity") +
  scale_y_continuous(breaks = c(-50, 0, 50, 100),
                     labels = c("50", "0", "50", "100")) +
  scale_x_discrete(limits = rev(levels(agaricales$family))) +
  annotate("text", x = "Pleurotaceae", y = 70, hjust = 0,
           label = paste0("N = ",
                          sum(abs(agaricales$n[agaricales$source == "Prylutskyi et al. 2023"]))),
           colour="#03bfc4", fontface = "italic") +
  annotate("text", x = "Omphalotaceae", y = 70, hjust = 0,
         label = paste0("N = ",
                        sum(abs(agaricales$n[agaricales$source == "iNaturalist"]))),
         colour="#f7766d", fontface = "italic") + 
  coord_flip() +
  labs(title = "(c) Number of species reported\n     (gilled Agaricales, Basidiomycota)",
       y = "Number of species", x = "Family", fill = NULL) +
  mytheme +
  theme(
    # legend.position = c(.75, .9)
    legend.position = "bottom"
        ) -> agaricales_comparison_plot

agaricales_comparison_plot
```

```{r, Lecanorales, message=FALSE, error=FALSE}
library(rgbif)

# iNaturalist
# Match taxonomic names against the GBIF Backbone Taxonomy
fungi %>%
  filter(taxon_order_name == "Lecanorales") %>%
  select(taxon_species_name) %>%
  rename(name = taxon_species_name) %>%
  filter(name != "") %>%
  st_drop_geometry() %>%
  distinct() %>%
  mutate(kingdom = "Fungi") %>%
  mutate_if(is.factor, as.character) %>%
  st_drop_geometry() %>%
  # Matching names against GBIF Backbone Taxonomy and tidying data
  name_backbone_checklist() %>%
  filter(!is.na(species)) %>%
  select(species,
         order,
         family,
         genus) %>% 
  filter(order == "Lecanorales") %>%
  mutate_if(is.character, as.factor) %>%
  group_by(family) %>%
  summarise(count(.)) %>%
  distinct() %>%
  mutate(n = -n) %>%
  mutate(source = "iNaturalist") -> inat_data_taxon


# Unique species from "Prodromus ..."
read.csv("./data/lecanorales.csv") %>%
  rename(name = scientificName) %>%
  mutate_if(is.factor, as.character) %>%
  # Matching names against GBIF Backbone Taxonomy and tidying data
  name_backbone_checklist() %>%
  filter(!is.na(species)) %>%
  select(species,
         order,
         family,
         genus) %>%
  filter(order == "Lecanorales") %>%
  mutate_if(is.character, as.factor) %>%
  group_by(family) %>%
  summarise(count(.)) %>%
  distinct() %>%
  mutate(source = "Kondratyuk et al. 2021") -> prodromus_data_taxon

lecanorales <- prodromus_data_taxon %>%
  bind_rows(inat_data_taxon) %>%
  mutate(family = as.factor(family))

lecanorales$n[lecanorales$source == "Kondratyuk et al. 2021"]

sum(abs(lecanorales$n[lecanorales$source == "Kondratyuk et al. 2021"]))

# Merge data and make a comparison barplot
lecanorales %>%  
  ggplot(aes(x = family, y = n, fill = source)) +
  geom_bar(stat = "identity") +
  scale_y_continuous(breaks = c(-50, 0, 50, 100, 150),
                     labels = c("50", "0", "50", "100", "150")) +
  scale_x_discrete(limits = rev(levels(lecanorales$family))) +
  annotate("text", x = "Stereocaulaceae", y = 100, hjust = 0,
           label = paste0("N = ",
                          sum(abs(lecanorales$n[lecanorales$source == "Kondratyuk et al. 2021"]))),
           colour="#03bfc4", fontface = "italic") +
    annotate("text", x = "Scoliciosporaceae", y = 100, hjust = 0,
           label = paste0("N = ",
                          sum(abs(lecanorales$n[lecanorales$source == "iNaturalist"]))),
           colour="#f7766d", fontface = "italic") + 
  coord_flip() +
  labs(title = "(d) Number of species reported\n     (Lecanorales, Ascomycota)",
       y = "Number of species", x = "Family", fill = NULL) +
  mytheme +
  theme(
    # legend.position = c(.75, .85)
    legend.position = "bottom"
    ) -> lecanorales_comparison_plot

lecanorales_comparison_plot
```


```{r, Figure 1, warning=FALSE, message=FALSE}
png("./figures/fig1_taxonomy.png", width = 24, height = 24, units = "cm", res = 300)
lay <- rbind(c(1,2),
             c(3,4),
             c(3,4))

gridExtra::grid.arrange(p_rarefaction,
                        id_agreements_p,
                        agaricales_comparison_plot,
                        lecanorales_comparison_plot,
                        layout_matrix = lay)
dev.off()

# Clean the Environment
rm(agaricales, agaricales_comparison_plot,
   lecanorales, lecanorales_comparison_plot,
   id_agreements_p, lay, out, p_rarefaction)
```

## Spatial distribution

```{r, Gridded observation density map}
# With pre-defined grid
# metric system (WGS 84 / Pseudo-Mercator)
pseudomercator_proj <- st_crs("EPSG:3857")

# Define the extent for grid
ua_extent <- st_as_sfc(st_bbox(c(xmin = 22, xmax = 41, 
                                 ymin = 44, ymax = 53), 
                               crs = st_crs("+proj=longlat +datum=WGS84")))

# Convert the extent to WGS 84 / Pseudo-Mercator projection
ua_extent_pseudomercator <- st_transform(ua_extent, crs = pseudomercator_proj)

# Create the grid in the Lambert Azimuthal Equal Area projection
grid_size_km <- sqrt(1000)  # 10 km grid cell size
grid_size_m <- grid_size_km * 1000  # Convert km to meters
grid_equal_area <- st_make_grid(ua_extent_pseudomercator, 
                                cellsize = c(grid_size_m, grid_size_m), 
                                what = "polygons") %>%  
  st_as_sf()

grid_equal_area$grid_cell_id <- 1:nrow(grid_equal_area)

# # Plot the grid
# ggplot() +
#   geom_sf(data = grid_equal_area) +
#   coord_sf(crs = pseudomercator_proj)

# Unify projections for point fungi data and the grid
fungi_projected <- st_transform(fungi, pseudomercator_proj)

# Perform a spatial join to associate each point with its corresponding grid cell
joined_data <- st_join(fungi_projected, grid_equal_area)

# Calculate number of points within each grid cell
num_observs <- joined_data %>%
  count(grid_cell_id)

# Assign mean richness values to the grid cells
grid_equal_area_count <- st_join(grid_equal_area, num_observs, 
                                 by = c("grid_cell_id" = "grid_cell_id")) %>%  
  drop_na(n) %>% 
  mutate(n_log = log(n))


# Plotting
# Make sure the basemap have the same projection than a grid
ukraine_proj <- st_transform(ukraine_poly, pseudomercator_proj)

# Check and correct geometry validity
grid_equal_area <- st_make_valid(grid_equal_area)
ukraine_proj <- st_make_valid(ukraine_proj)

# Cut grid 
cut_grid <- st_intersection(grid_equal_area, ukraine_proj)

breaks <- c(min(grid_equal_area_count$n),
            10,
            100,
            1000,
            max(grid_equal_area_count$n))

# Create a new variable in your data that categorizes 'n' based on the defined breaks
grid_equal_area_count$category <- cut(grid_equal_area_count$n, 
                                      breaks = breaks, 
                                      include.lowest = TRUE)

# Convert the category to a factor to ensure it's treated as discrete
grid_equal_area_count$category <- as.factor(grid_equal_area_count$category)

ggplot(data = ukraine_proj) +
  geom_sf(fill = "transparent", colour = "gray") +
  geom_sf(data = grid_equal_area_count, aes(fill = category)) +
  scale_fill_viridis_d(option = "C", name = "Observations\nper 1000 km sq.",
                     labels = c("1-10",
                                "11-100",
                                "101-1000", 
                                "1001-6543")) +
  ggspatial::annotation_scale(location = "bl",
                            bar_cols = c("grey60", "white")) +
  labs(title = "   (a) iNaturalist observation density") +
  theme_void() +
  theme(legend.position = "bottom") -> observation_density_p

observation_density_p
```

How many of the territory have no observations?

```{r}
grid_ua <- sf::st_intersection(grid_equal_area, ukraine_proj)
1 - (nrow(grid_equal_area_count)/nrow(grid_ua))
```

```{r, Population density map}
major_cities <- data.frame(name = c("Kyiv", "Kharkiv"),
                           latitude = c(50.44422, 49.99098),
                           longitude = c(30.50894, 36.23333)) %>% 
  # convert to `simple features` spatial object
  st_as_sf(dim = "XY", remove = TRUE, na.fail = F, 
                      coords = c("longitude", "latitude"),
           crs = "+proj=longlat +datum=WGS84 +no_defs")

mountain_range_labels <- data.frame(name = c("the Carpathians", "Crimean Mts."),
                                    latitude = c(48.52306, 44.79670),
                                    longitude = c(23.98829, 34.25411)) %>% 
  # convert to `simple features` spatial object
  st_as_sf(dim = "XY", remove = TRUE, na.fail = F, 
                      coords = c("longitude", "latitude"),
           crs = "+proj=longlat +datum=WGS84 +no_defs")
  

crimean_mount <- st_read("./data/crimean_mount.shp")

carpathians <- st_read("./data/carpathians.shp")

library(terra)
population <- terra::rast("./data/nasa_population_density_2020/gpw-v4-population-density-rev11_2020_2pt5_min_tif/gpw_v4_population_density_rev11_2020_2pt5_min.tif")

population_ua <- crop(population, vect(ukraine_poly))
population_ua <- terra::mask(population_ua, vect(ukraine_poly))

# 2.5 minute
as.data.frame(population_ua, xy = TRUE) %>% drop_na() %>% 
    rename(value = 3) %>% 
    ggplot() +
      geom_sf(fill = "transparent", colour = "lightgray", data = ukraine_poly) +
      geom_raster(aes(x = x, y = y, fill = value)) +
  geom_sf(data = carpathians, fill = "transparent", colour = "lightgray",
          linewidth = .5,
          linetype = 2) +
  geom_sf(data = crimean_mount, fill = "transparent", colour = "lightgray",
          linewidth = .5,
          linetype = 2) +
  ggrepel::geom_label_repel(
    data = head(major_cities),
    aes(label = name, geometry = geometry),
    stat = "sf_coordinates",
    nudge_x = 4, nudge_y = 2,
    min.segment.length = 0,
    segment.color = "lightgrey"
  ) +
  ggrepel::geom_label_repel(
    data = head(mountain_range_labels),
    aes(label = name, geometry = geometry),
    stat = "sf_coordinates",
    nudge_x = -4, nudge_y = -1,
    min.segment.length = 0,
    segment.color = "lightgrey"
  ) +
  scale_fill_viridis_c(
    limits = c(0, 5000), breaks = c(0, 5000) , option = 'C'
    ) +
      labs(x = "", y = "", fill = "People per grid cell 2.5 minute",
          title = "   (b) Ukrainian population density as of 2020") + 
  ggspatial::annotation_scale(location = "bl",
                              bar_cols = c("grey60", "white")) +
  theme_void() +
  theme(legend.position = "bottom") -> population_density_p

population_density_p
```

```{r, Case species}
# Read data about selected species, obtained from other sources (publications, GBIF)
selected_spp_other_sources <- read.csv("./data/hericium_clathrus.csv") %>% 
  mutate(source = "publications, collections") %>% 
  # remove duplicates
  distinct() %>% 
  # convert to `simple features` spatial object
  st_as_sf(dim = "XY", remove = TRUE, na.fail = F, 
                      coords = c("longitude", "latitude"),
           crs = "+proj=longlat +datum=WGS84 +no_defs") %>% 
  # clip by country polygon
  st_filter(ukraine_poly) %>% 
  # drop records without coordinates
  filter(!st_is_empty(.))

# Subset iNaturalist data for selected species
fungi %>% 
  filter(taxon_species_name %in% c("Hericium coralloides",
                                   "Clathrus archeri"
                                   )) %>% 
  distinct() %>% 
  mutate(source = "iNaturalist") %>% 
  select(taxon_species_name, source) -> selected_spp_inat

# Merge both sources together and rename species
selected_spp_other_sources %>% bind_rows(selected_spp_inat) %>%
  mutate(taxon_species_name = factor(taxon_species_name, ordered = TRUE,
                                     levels = c("Hericium coralloides",
                                               "Clathrus archeri"
                                               ))) -> selected_spp

selected_spp %>% 
  filter(taxon_species_name == "Hericium coralloides") %>% 
  ggplot() +
  geom_sf(data = ukraine_poly, fill = "transparent", colour = "gray") +
  geom_sf(aes(colour = source), alpha = 0.7) +
  labs(title = "   (c) Records of Hericium coralloides",
       colour = "Data source") +
  # ggspatial::annotation_scale(location = "bl",
  #                             bar_cols = c("grey60", "white")) +
  annotate("text", x = 24, y = 47, hjust = 0,
           label = paste0("N = ",
                          nrow(selected_spp[selected_spp$source == "iNaturalist" &
                                              selected_spp$taxon_species_name == "Hericium coralloides",])
                          ), 
           colour="#f7766d", fontface = "italic") +
  annotate("text", x = 24, y = 46, hjust = 0,
           label = paste0("N = ",
                          nrow(selected_spp[selected_spp$source == "publications, collections" &
                                              selected_spp$taxon_species_name == "Hericium coralloides",])
                          ), 
           colour="#03bfc4", fontface = "italic") +
  theme_void() +
  theme(legend.position = "bottom") -> hericium_plot

hericium_plot

selected_spp %>% 
  filter(taxon_species_name == "Clathrus archeri") %>% 
  ggplot() +
  geom_sf(data = ukraine_poly, fill = "transparent", colour = "gray") +
  geom_sf(aes(colour = source), 
          alpha = 0.7
          ) +
  ggspatial::annotation_scale(location = "bl",
                              bar_cols = c("grey60", "white")) +
  annotate("text", x = 24, y = 47, hjust = 0,
           label = paste0("N = ",
                          nrow(selected_spp[selected_spp$source == "iNaturalist" &
                                              selected_spp$taxon_species_name == "Clathrus archeri",])
                          ), 
           colour="#f7766d", fontface = "italic") +
  annotate("text", x = 24, y = 46, hjust = 0,
           label = paste0("N = ",
                          nrow(selected_spp[selected_spp$source == "publications, collections" &
                                              selected_spp$taxon_species_name == "Clathrus archeri",])
                          ), 
           colour="#03bfc4", fontface = "italic") +
  labs(title = "(d) Records of Clathrus archeri",
       colour = "Data source") +
  theme_void() +
  theme(legend.position = "bottom") -> clathrus_plot

clathrus_plot
```

```{r, Figure 2, warning=FALSE}
# Combined plot
png("./figures/fig2_distribution.png", width = 24, height = 20, units = "cm", res = 300)
lay <- rbind(c(1,2),
             c(3,4))

gridExtra::grid.arrange(observation_density_p,
                        population_density_p,
                        hericium_plot,
                        clathrus_plot,
                        layout_matrix = lay)
dev.off()

# Clean the Environment
rm(clathrus_plot, hericium_plot, lay,
   observation_density_p, population,
   population_density_p, population_ua,
   selected_spp, selected_spp_inat, selected_spp_other_sources,
   cut_grid, fungi_projected, grid_equal_area,
   grid_equal_area_count, joined_data, num_observs,
   carpathians, crimean_mount,
   pseudomercator_proj, ukraine_proj, ua_extent, 
   ua_extent_pseudomercator, grid_cell_id, grid_size_km, grid_size_m)
```

## Social dimension

```{r, Observation accumulation}
# Accumulation of observations by date
fungi %>%
  filter(!is.na(observed_on)) %>%
  count(observed_on) %>%
  mutate(cum_sum = cumsum(n)) %>%
  ggplot(aes(x = observed_on, y = cum_sum)) +
  geom_area(alpha = .8) +
  scale_x_date(limits = c(as.Date("2000-01-01"),
                          as.Date("2024-06-01"))) +
  annotate("rect",
           xmin = as.Date("2022-02-24"),
           xmax = as.Date("2024-06-01"),
           ymin = -1, ymax = Inf,
           alpha = .2, fill = "red") +
  annotate("rect",
           xmin = as.Date("2000-06-01"),
           xmax = as.Date("2001-06-01"),
           ymin = 48000, ymax = 52000,
           alpha = .2, fill = "red") +
  annotate("text",
           x = as.Date("2003-01-01"), y = 50000,
           label = "Full-scale invasion", hjust = 0) +
  annotate("rect",
           xmin = as.Date("2019-03-01"),
           xmax = as.Date("2022-02-24"),
           ymin = -1, ymax = Inf,
           alpha = .2, fill = "blue") +
  annotate("rect", xmin = as.Date("2000-06-01"),
           xmax = as.Date("2001-06-01"),
           ymin = 42000, ymax = 46000,
           alpha = .2, fill = "blue") +
  annotate("text",
           x = as.Date("2003-01-01"), y = 44000,
           label = "COVID-19", hjust = 0) +
  labs(title = "(a) Observation accumulation, country level",
       x = "Time",
       y = "Total number of observations") +
  mytheme -> accumulation_plot

accumulation_plot
```

```{r, Hyper-prolific users statistics}
fungi %>% 
  as.data.frame() %>% 
  count(user_id) %>% 
  arrange(-n) -> user_stat

# How many users have made 100 or more observations?
nrow(user_stat[user_stat$n >= 100, ])

# Fraction of total observers made more than 100 fungal observations ever
paste0(round(nrow(user_stat[user_stat$n >= 100, ]) / nrow(user_stat) * 100, digits = 1), " %")

# How many observations those users have contributed?
# IDs of users contributed >= 100 obs
hyper_prolific_users <- user_stat %>% 
  filter(n >= 100) %>% 
  pull(user_id)

# No of obs. made by those users
fungi %>% 
  as.data.frame() %>% 
  filter(user_id %in% hyper_prolific_users) %>% 
  nrow() -> obs_by_hyper_prolific_users

print(obs_by_hyper_prolific_users)

# Fraction of total observations
paste0(round(obs_by_hyper_prolific_users / nrow(fungi) * 100, digits = 1), " %")
```

```{r, Observation accumulation per region}
fungi %>%
  filter(!is.na(observed_on)) %>%
  mutate(year = year(observed_on)) %>% 
  filter(!is.na(year)) %>% 
  filter(year >= "2018" & year <= "2023") %>% 
  count(place_admin1_name, year) %>% 
  rename(shapeName = place_admin1_name) %>% 
  st_drop_geometry() %>% 
  left_join(ukraine_poly, by = "shapeName") %>% 
  group_by(shapeName) %>%
  arrange(year) %>% 
  select(shapeName, year, n, geometry) %>%
  filter(year >= 2019) %>% 
  rename(place_admin1_name = shapeName) %>% 
  st_as_sf() %>% 
  # count(observed_on) %>%
  mutate(cum_sum = cumsum(n)) -> df
  ggplot(df) +
  geom_sf(aes(fill = cum_sum), 
          linewidth = 0.01) +
  scale_fill_viridis_c(
    limits = c(0, 10000),
    breaks = c(0, 10000) ,
    option = 'C'
    ) +
  labs(title = "(b) Total number of\nobservations per region\n",
       fill = NULL) +
  facet_wrap(vars(year), ncol = 1) +
  theme_void() +
  theme(legend.position = "bottom") -> p_accum_countrywide

p_accum_countrywide
```

```{r, Activity dynamics per region}
fungi %>% 
  mutate(year = year(observed_on)) %>% 
  filter(!is.na(year)) %>% 
  filter(year >= "2018" & year <= "2023") %>% 
  count(place_admin1_name, year) %>% 
  rename(shapeName = place_admin1_name) %>% 
  st_drop_geometry() %>% 
  left_join(ukraine_poly, by = "shapeName") %>% 
  group_by(shapeName) %>%
  arrange(year) %>% 
  mutate(
    diff_n = ifelse(year == 2018, n, n - lag(n))
  ) %>%
  ungroup() %>% 
  select(shapeName, year, n, diff_n, geometry) %>%
  filter(year >= 2019) %>% 
  rename(place_admin1_name = shapeName) %>% 
  mutate(diff_n = replace_na(diff_n, 0)) %>% 
  st_as_sf() -> df
  ggplot(df) +
  geom_sf(aes(fill = diff_n)) +
  scale_fill_gradient2(high = "darkred", low = "darkblue", mid = "white", 
                                     midpoint = 0,
                       limits = c(min(df$diff_n), max(df$diff_n)),
                       breaks = c(max(df$diff_n), min(df$diff_n)),
                       labels = c("increase", "decrease")
                       ) +
  facet_wrap(vars(year), ncol = 1) +
  labs(
    title = "(c) Changes in\nobservers' activity\n",
    fill = NULL
  ) +
  theme_void() +
  theme(legend.position = "bottom") -> p_dynamics_regions

p_dynamics_regions
```

```{r, War events}
library(ggrepel)

selected_regions <- ukraine_poly %>% 
  filter(shapeName %in% c("Kharkiv Oblast",
                          "Kyiv Oblast",
                          "Kyiv",
                          "Kherson Oblast",
                          "Autonomous Republic of Crimea")) %>% 
  mutate(shapeName = factor(shapeName, ordered = TRUE, 
                               levels = c("Kharkiv Oblast",
                                          "Kyiv Oblast",
                                          "Kyiv",
                                          "Kherson Oblast",
                                          "Autonomous Republic of Crimea")))

# Shift of ggrepel::labels
nudge_x <- c(-2, 4,4,4,-2)
nudge_y <- c(-2, 2,2,2,-2)

# Ukraine Conflict Monitor (from ACLED)
# https://acleddata.com/ukraine-conflict-monitor/#analysis

read.csv("./data/Ukraine_Black_Sea_2020_2024_May24.csv") %>% 
  select(event_date, year, event_type, country, latitude, longitude) %>% 
  mutate(event_date = as.Date(event_date)) %>% 
  filter(event_date >= "2022-02-24") %>% 
  # convert to `simple features` spatial object
  st_as_sf(dim = "XY", remove = TRUE, na.fail = F, 
                      coords = c("longitude", "latitude"), 
           crs = "+proj=longlat +datum=WGS84 +no_defs") %>% 
  # clip by country polygon
  st_filter(ukraine_poly) %>% 
  # drop records without coordinates
  filter(!st_is_empty(.)) -> df
ggplot(data = df) +
  geom_sf(alpha = 0.1, colour = "red") +
  geom_sf(data = ukraine_poly, fill = "transparent", colour = "gray",
          linewidth = 0.5) +
  ggrepel::geom_label_repel(
    data = selected_regions,
    aes(label = shapeName, geometry = geometry),
    stat = "sf_coordinates",
    nudge_x = nudge_x,
    nudge_y = nudge_y,
    min.segment.length = 0,
    max.overlaps = Inf,
    # segment.color = "lightgrey"
  ) +
  ggspatial::annotation_scale(location = "bl",
                              bar_cols = c("grey60", "white")) +
  labs(title = "     (d) War events since 2022-02-24") +
  theme_void() -> p_acled

p_acled
```

```{r, Figure 3}
png("./figures/fig3_social.png", width = 24, height = 20, units = "cm", res = 300)
lay <- rbind(c(1,1,2,3),
             c(1,1,2,3),
             c(4,4,2,3),
             c(4,4,2,3)
             )

gridExtra::grid.arrange(
  accumulation_plot,
  p_accum_countrywide,
  p_dynamics_regions,
  p_acled,
  layout_matrix = lay
                        )
dev.off()

# Clean the Environment
rm(accumulation_plot,
  p_accum_countrywide,
  p_dynamics_regions,
  p_acled
  )
```

